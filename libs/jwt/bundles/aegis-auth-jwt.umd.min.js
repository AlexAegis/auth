!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("@angular/common/http"),require("@angular/router"),require("js-base64"),require("@angular/common")):"function"==typeof define&&define.amd?define("@aegis-auth/jwt",["exports","@angular/core","rxjs","rxjs/operators","@angular/common/http","@angular/router","js-base64","@angular/common"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self)["aegis-auth"]=e["aegis-auth"]||{},e["aegis-auth"].jwt={}),e.ng.core,e.rxjs,e.rxjs.operators,e.ng.common.http,e.ng.router,e.jsBase64,e.ng.common)}(this,(function(e,r,t,n,o,i,a,s){"use strict";function u(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}var c=u(r),f=u(o),l=u(i),h=function(e){return void 0===e&&(e=-1/0),e<Math.floor((new Date).getTime()/1e3)},p={getValue:new t.BehaviorSubject(null)},d="Authorization",v="Bearer ",g=Object.assign(Object.assign({},p),{header:d,scheme:v,handleWithCredentials:!0}),w=!0,y={method:"POST",errorCodeWhitelist:[401],isAutoRefreshAllowedInLoginGuardByDefault:w},j=function(e,r){return(j=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])})(e,r)};function T(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function t(){this.constructor=e}j(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}Object.create;function R(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,o,i=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return a}function E(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(R(arguments[r]));return e}Object.create;var m=function(e){function r(t,n,o){void 0===o&&(o=r.type);var i=e.call(this,o)||this;return i.originalRequest=t,i.originalError=n,i}return T(r,e),r.createErrorResponse=function(e,t){return new o.HttpErrorResponse({error:r.createErrorEvent(e,t)})},r.createErrorEvent=function(e,t){return new ErrorEvent(r.type,{error:new r(e,t)})},r}(Error);m.type="JWT_ERROR";var k=function(e){function r(t,n){var o=e.call(this,t,n,r.type)||this;return o.originalRequest=t,o.originalError=n,o}return T(r,e),r.createErrorResponse=function(e,t){return new o.HttpErrorResponse({error:r.createErrorEvent(e,t)})},r.createErrorEvent=function(e,t){return new ErrorEvent(r.type,{error:new r(e,t)})},r}(m);k.type="JWT_CANNOT_REFRESH_ERROR";var C=function(e){function r(t,n){var o=e.call(this,t,n,r.type)||this;return o.originalRequest=t,o.originalError=n,o}return T(r,e),r.createErrorResponse=function(e,t){return new o.HttpErrorResponse({error:r.createErrorEvent(e,t)})},r.createErrorEvent=function(e,t){return new ErrorEvent(r.type,{error:new r(e,t)})},r}(m);C.type="JWT_COULDNT_REFRESH_ERROR";var O=function(e){return"string"==typeof e},b=function(e,r,t,n){if(O(e)){if(!t)throw new Error("JWT Refresh configuration error! `onFailure` is defined as a string, but the Router is not available! Is @angular/router installed and the RouterModule imported?");var o=n;"function"==typeof n&&(o=n(r)),t.navigate([e],{queryParams:o})}else e(r)},I=function(e){return null!=e},A=function(e,r,n,o){var i,a=null===(i=e.error)||void 0===i?void 0:i.error;return a instanceof k||a instanceof C?(n&&I(n.onFailure)&&b(n.onFailure,a,o,n.onFailureRedirectParameters),t.throwError(a)):a instanceof m?(I(r.onFailure)&&b(r.onFailure,a,o,r.onFailureRedirectParameters),t.throwError(a)):t.throwError(e)},S=function(e){return"function"==typeof e},_=function(e){return!!e&&"function"==typeof e.then&&"function"==typeof e.catch},P=function(e){return t.isObservable(e)?e:S(e)?t.of(null).pipe(n.switchMap((function(){var r=e();return t.isObservable(r)?r:_(r)?t.from(r):t.of(r)}))):_(e)?t.from(e):t.of(e)},$=function(e){return(r=Math.floor(1e3*e))-(new Date).getTime()<0?t.of(!0):t.merge(t.of(!1),t.timer(new Date(r)).pipe(n.mapTo(!0)));var r},H=function(e){return e.type===o.HttpEventType.Response},x=function(e,r,t,i,a,s){var u,c,f=new o.HttpRequest(null!==(u=t.method)&&void 0!==u?u:"POST",t.refreshUrl,r,(c=t.refreshRequestInitials,S(c)?c():c));return i.next(!0),e.handle(f).pipe(n.filter(H),n.map((function(e){return t.transformRefreshResponse(e.body)})),n.tap((function(e){return t.setRefreshedTokens(e)})),n.mergeMap((function(e){return s(e)})),n.finalize((function(){return i.next(!1)})),n.catchError(a))},D=function(e,r,o,i,a,s){var u,c,f,l,h,p,d,v;return"string"==typeof r||(c=r,p=function(e){return e===c.status},d=null===(l=null===(f=(u=o).errorCodeWhitelist)||void 0===f?void 0:f.some(p))||void 0===l||l,v=!(null===(h=u.errorCodeBlacklist)||void 0===h?void 0:h.some(p)),d&&v)?P(o.createRefreshRequestBody).pipe(n.take(1),n.switchMap((function(t){return t?x(e,t,o,i,a,s):a(r)}))):t.throwError(r)},J=function(e){try{return JSON.parse(a.Base64.decode(e))}catch(e){return console.error("Invalid Jsonlike Base64 string",e),null}},N=function(){function e(e,r,t){this.header=e,this.payload=r,this.signature=t}return e.from=function(r){var t=e.splitTokenString(r);if(!t)return null;var n=J(t[0]),o=J(t[1]),i=a.Base64.decode(t[2]);return n&&o&&i?new e(n,o,i):null},e.stripScheme=function(e,r){return e.substring((null!=r?r:"").length)},e.splitTokenString=function(r,t){void 0===t&&(t=e.JWT_TOKEN_SEPARATOR);var n=r.split(t);return 3!==n.length?null:n},e.prototype.isExpired=function(){return h(this.payload.exp)},e}();N.JWT_TOKEN_SEPARATOR=".";var F=new r.InjectionToken("AegisJwtConfiguration"),M=new r.InjectionToken("DefaultAegisJwtConfiguration"),W=new r.InjectionToken("AegisJwtRefreshConfiguration"),L=new r.InjectionToken("DefaultAegisJwtRefreshConfiguration"),B=function(){this.refreshLock$=new t.BehaviorSubject(!1)};B.ɵprov=c.ɵɵdefineInjectable({factory:function(){return new B},token:B,providedIn:"root"}),B.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}];var U=function(){function e(e,r,o,i,a,s,u){var c;this.httpHandler=e,this.jwtRefreshStateService=r,this.rawConfig=o,this.rawDefaultConfig=i,this.rawDefaultRefreshConfig=a,this.rawRefreshConfig=s,this.router=u,this.config=Object.assign(Object.assign({},this.rawDefaultConfig),this.rawConfig),this.refreshConfig=this.rawDefaultRefreshConfig&&this.rawRefreshConfig?Object.assign(Object.assign({},this.rawDefaultRefreshConfig),this.rawRefreshConfig):void 0,this.rawAccessToken$=P(this.config.getToken),this.rawRefreshToken$=(null===(c=this.refreshConfig)||void 0===c?void 0:c.getRefreshToken)?P(this.refreshConfig.getRefreshToken):t.of(null),this.accessToken$=this.rawAccessToken$.pipe(n.map((function(e){if(O(e)){var r=N.from(e);if(r)return r;throw new Error("Non-valid token observed")}return null}))),this.refreshToken$=this.rawRefreshToken$.pipe(n.map((function(e){if(O(e)){var r=N.from(e);if(r)return r;throw new Error("Non-valid token observed")}return null}))),this.accessTokenHeader$=this.accessToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.header)&&void 0!==r?r:null}))),this.accessTokenPayload$=this.accessToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.payload)&&void 0!==r?r:null}))),this.refreshTokenHeader$=this.refreshToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.header)&&void 0!==r?r:null}))),this.refreshTokenPayload$=this.refreshToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.payload)&&void 0!==r?r:null}))),this.isAccessTokenExpired$=this.accessToken$.pipe(n.switchMap((function(e){return e?$(e.payload.exp):t.of(null)}))),this.isRefreshTokenExpired$=this.refreshToken$.pipe(n.switchMap((function(e){return e?$(e.payload.exp):t.of(null)}))),this.isAccessTokenValid$=this.isAccessTokenExpired$.pipe(n.map((function(e){return I(e)&&!e}))),this.isRefreshTokenValid$=this.isRefreshTokenExpired$.pipe(n.map((function(e){return I(e)&&!e})))}return e.prototype.manualRefresh=function(){var e=this;return this.refreshConfig?D(this.httpHandler,"Access token not valid on guard activation",this.refreshConfig,this.jwtRefreshStateService.refreshLock$,(function(r){return A(C.createErrorResponse(void 0,r),e.config,e.refreshConfig,e.router).pipe(n.catchError((function(){return t.of(!1)})))}),(function(){return t.of(!0)})):t.of(!1)},e}();U.ɵprov=c.ɵɵdefineInjectable({factory:function(){return new U(c.ɵɵinject(f.HttpHandler),c.ɵɵinject(B),c.ɵɵinject(F),c.ɵɵinject(M),c.ɵɵinject(L,8),c.ɵɵinject(W,8),c.ɵɵinject(l.Router,8))},token:U,providedIn:"root"}),U.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],U.ctorParameters=function(){return[{type:o.HttpHandler},{type:B},{type:void 0,decorators:[{type:r.Inject,args:[F]}]},{type:void 0,decorators:[{type:r.Inject,args:[M]}]},{type:void 0,decorators:[{type:r.Inject,args:[L]},{type:r.Optional}]},{type:void 0,decorators:[{type:r.Inject,args:[W]},{type:r.Optional}]},{type:i.Router,decorators:[{type:r.Optional}]}]};var q=function(){function e(e){this.jwtTokenService=e,this.isAccessTokenValidOnce$=this.jwtTokenService.isAccessTokenValid$.pipe(n.take(1))}return e.prototype.canActivate=function(e,r){var t=e.data;return this.isValid(null==t?void 0:t.isRefreshAllowed)},e.prototype.canActivateChild=function(e,r){var t=e.data;return this.isValid(null==t?void 0:t.isRefreshAllowed)},e.prototype.canLoad=function(e,r){var t=e.data;return this.isValid(null==t?void 0:t.isRefreshAllowed)},e.prototype.isValid=function(e){var r,o,i=this,a=null!==(o=null!=e?e:null===(r=this.jwtTokenService.refreshConfig)||void 0===r?void 0:r.isAutoRefreshAllowedInLoginGuardByDefault)&&void 0!==o?o:w;return this.isAccessTokenValidOnce$.pipe(n.switchMap((function(e){return!e&&a?i.jwtTokenService.manualRefresh():t.of(e)})))},e}();q.ɵprov=c.ɵɵdefineInjectable({factory:function(){return new q(c.ɵɵinject(U))},token:q,providedIn:"root"}),q.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],q.ctorParameters=function(){return[{type:U}]};var G=function(){function e(e,r,t,n,o){this.router=o,this.jwtConfiguration=Object.assign(Object.assign({},r),e),this.jwtRefreshConfiguration=n&&t?Object.assign(Object.assign({},n),t):void 0}return e.prototype.intercept=function(e,r){var t=this;return r.handle(e).pipe(n.catchError((function(e){return A(e,t.jwtConfiguration,t.jwtRefreshConfiguration,t.router)})))},e}();G.decorators=[{type:r.Injectable}],G.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[F]}]},{type:void 0,decorators:[{type:r.Inject,args:[M]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[W]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[L]}]},{type:i.Router,decorators:[{type:r.Optional}]}]};var V=function(e,r){return O(e)?e===r:!!r&&e.test(r)},z=function(e,r){return void 0===r&&(r=!1),function(t){return r?!V(t,e):V(t,e)}},K=function(e,r){var t,n,o,i,a,s,u,c,f,l=r.domain,h=r.path,p=r.protocol,d=z(p),v=z(l),g=z(h),w=null===(n=null===(t=e.protocolWhitelist)||void 0===t?void 0:t.some(d))||void 0===n||n,y=!(null===(o=e.protocolBlacklist)||void 0===o?void 0:o.some(d)),j=null===(a=null===(i=e.domainWhitelist)||void 0===i?void 0:i.some(v))||void 0===a||a,T=!(null===(s=e.domainBlacklist)||void 0===s?void 0:s.some(v)),R=null===(c=null===(u=e.pathWhitelist)||void 0===u?void 0:u.some(g))||void 0===c||c,E=!(null===(f=e.pathBlacklist)||void 0===f?void 0:f.some(g));return w&&y&&j&&T&&R&&E},Q=function(e){var r=null==e?void 0:e.match(/^((.*):\/\/)?([^/].*?)?(\/(.*))?$/);return{protocol:null==r?void 0:r[2],domain:null==r?void 0:r[3],path:null==r?void 0:r[5]}},X=function(){function e(e,r,t,n){this.jwtConfiguration=Object.assign(Object.assign({},r),e),this.jwtRefreshConfiguration=t&&n&&Object.assign(Object.assign({},n),t)}return e.prototype.intercept=function(e,r){var o=this,i=Q(e.url);return P(this.jwtConfiguration.getToken).pipe(n.take(1),n.switchMap((function(n){if(K(o.jwtConfiguration,i)){var a=n&&N.from(n),s=!a||a.isExpired();if(!n||s&&!o.jwtRefreshConfiguration)return t.throwError(m.createErrorResponse(e,"Token is expired or invalid, and refresh is not configured."));var u=e.clone({headers:e.headers.set(o.jwtConfiguration.header,o.jwtConfiguration.scheme?o.jwtConfiguration.scheme+n:n)});return o.jwtConfiguration.handleWithCredentials&&(u=u.clone({withCredentials:!0})),r.handle(u)}return r.handle(e)})))},e}();X.decorators=[{type:r.Injectable}],X.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[F]}]},{type:void 0,decorators:[{type:r.Inject,args:[M]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[W]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[L]}]}]};var Y=function(){function e(e,r,t,n,o,i){var a;this.jwtConfig=e,this.defaultJwtConfig=r,this.refreshConfig=t,this.defaultJwtRefreshConfig=n,this.jwtRefreshStateService=o,this.jwtTokenService=i,this.jwtConfiguration=Object.assign(Object.assign({},r),e),this.jwtRefreshConfiguration=Object.assign(Object.assign({},n),t),this.rawRefreshToken$=P(null!==(a=this.jwtRefreshConfiguration.getRefreshToken)&&void 0!==a?a:function(){return null}),this.isRawRefreshTokenGetterAvailable=!!this.jwtRefreshConfiguration.getRefreshToken}return e.prototype.handleWithToken=function(e,r,t){var n=e.clone({headers:e.headers.set(this.jwtConfiguration.header,this.jwtConfiguration.scheme+t)});return r.handle(n)},e.prototype.intercept=function(e,r){var o=this,i=Q(e.url),a=e.headers.get(this.jwtConfiguration.header);return a&&!z(e.url)(this.jwtRefreshConfiguration.refreshUrl)&&K(this.jwtRefreshConfiguration,i)?this.jwtRefreshStateService.refreshLock$.value?this.jwtRefreshStateService.refreshLock$.pipe(n.filter((function(e){return!e})),n.take(1),n.withLatestFrom(this.jwtTokenService.rawAccessToken$),n.switchMap((function(n){var i=R(n,2)[1];return i?o.handleWithToken(e,r,i):t.throwError(m.createErrorResponse(e,"No access token available after waiting for a refresh"))}))):this.rawRefreshToken$.pipe(n.take(1),n.switchMap((function(i){var s=N.stripScheme(a,o.jwtConfiguration.scheme),u=N.from(s),c=i?N.from(i):null,f=!u||u.isExpired(),l=!c||c.isExpired();return f&&o.isRawRefreshTokenGetterAvailable&&l?t.throwError(k.createErrorResponse(e,"Both access and refresh tokens are expired")):(f?t.throwError("Expired token, refresh first"):r.handle(e)).pipe(n.catchError((function(n){return D(r,n,o.jwtRefreshConfiguration,o.jwtRefreshStateService.refreshLock$,(function(r){return t.throwError(C.createErrorResponse(e,r))}),(function(t){return o.handleWithToken(e,r,t.accessToken)}))})))}))):r.handle(e)},e}();Y.decorators=[{type:r.Injectable}],Y.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[F]}]},{type:void 0,decorators:[{type:r.Inject,args:[M]}]},{type:void 0,decorators:[{type:r.Inject,args:[W]}]},{type:void 0,decorators:[{type:r.Inject,args:[L]}]},{type:B},{type:U}]};var Z,ee=function(e){return Object.assign({provide:F,multi:!1},e)},re=function(e){return Object.assign({provide:W,multi:!1},e)},te=function(){function e(){}return e.forRoot=function(r,t){return{ngModule:e,providers:E([{provide:o.HTTP_INTERCEPTORS,useClass:G,multi:!0},{provide:o.HTTP_INTERCEPTORS,useClass:X,multi:!0},{provide:M,useValue:g},ee(r)],t?[{provide:o.HTTP_INTERCEPTORS,useClass:Y,multi:!0},{provide:L,useValue:y},re(t)]:[])}},e}();te.decorators=[{type:r.NgModule,args:[{imports:[s.CommonModule]}]}],e.HttpMethod=void 0,(Z=e.HttpMethod||(e.HttpMethod={})).GET="GET",Z.HEAD="HEAD",Z.POST="POST",Z.PUT="PUT",Z.DELETE="DELETE",Z.CONNECT="CONNECT",Z.OPTIONS="OPTIONS",Z.TRACE="TRACE",Z.PATCH="PATCH",e.DEFAULT_HEADER_CONFIG=p,e.DEFAULT_JWT_CONFIG=g,e.DEFAULT_JWT_HEADER=d,e.DEFAULT_JWT_REFRESH_CONFIG=y,e.DEFAULT_JWT_REFRESH_CONFIG_DEFAULT_AUTO_IN_GUARD=w,e.DEFAULT_JWT_SCHEME=v,e.JwtModule=te,e.JwtRefreshStateService=B,e.JwtToken=N,e.JwtTokenService=U,e.LoginGuard=q,e.createJwtConfigurationProvider=ee,e.createJwtRefreshConfigurationProvider=re,e.isUnixTimestampExpired=h,e.ɵa=U,e.ɵb=F,e.ɵc=M,e.ɵd=W,e.ɵe=L,e.ɵf=B,e.ɵg=G,e.ɵh=X,e.ɵi=Y,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=aegis-auth-jwt.umd.min.js.map