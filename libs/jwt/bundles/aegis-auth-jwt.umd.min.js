!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("@angular/core"),require("rxjs"),require("rxjs/operators"),require("@angular/common/http"),require("@angular/router"),require("js-base64"),require("@angular/common")):"function"==typeof define&&define.amd?define("@aegis-auth/jwt",["exports","@angular/core","rxjs","rxjs/operators","@angular/common/http","@angular/router","js-base64","@angular/common"],r):r(((e="undefined"!=typeof globalThis?globalThis:e||self)["aegis-auth"]=e["aegis-auth"]||{},e["aegis-auth"].jwt={}),e.ng.core,e.rxjs,e.rxjs.operators,e.ng.common.http,e.ng.router,e.jsBase64,e.ng.common)}(this,(function(e,r,t,n,o,i,a,s){"use strict";var u=function(e){return void 0===e&&(e=-1/0),e<Math.floor((new Date).getTime()/1e3)},c={getValue:new t.BehaviorSubject(null)},f="Authorization",l="Bearer ",p=Object.assign(Object.assign({},c),{header:f,scheme:l,handleWithCredentials:!0}),h=!0,d={method:"POST",errorCodeWhitelist:[401],isAutoRefreshAllowedInLoginGuardByDefault:h},v=function(e,r){return(v=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,r){e.__proto__=r}||function(e,r){for(var t in r)Object.prototype.hasOwnProperty.call(r,t)&&(e[t]=r[t])})(e,r)};function g(e,r){function t(){this.constructor=e}v(e,r),e.prototype=null===r?Object.create(r):(t.prototype=r.prototype,new t)}Object.create;function T(e,r){var t="function"==typeof Symbol&&e[Symbol.iterator];if(!t)return e;var n,o,i=t.call(e),a=[];try{for(;(void 0===r||r-- >0)&&!(n=i.next()).done;)a.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(t=i.return)&&t.call(i)}finally{if(o)throw o.error}}return a}function y(){for(var e=[],r=0;r<arguments.length;r++)e=e.concat(T(arguments[r]));return e}Object.create;var w=function(e){function r(t,n,o){void 0===o&&(o=r.type);var i=e.call(this,o)||this;return i.originalRequest=t,i.originalError=n,i}return g(r,e),r.createErrorResponse=function(e,t){return new o.HttpErrorResponse({error:r.createErrorEvent(e,t)})},r.createErrorEvent=function(e,t){return new ErrorEvent(r.type,{error:new r(e,t)})},r}(Error);w.type="JWT_ERROR";var E=function(e){function r(t,n){var o=e.call(this,t,n,r.type)||this;return o.originalRequest=t,o.originalError=n,o}return g(r,e),r.createErrorResponse=function(e,t){return new o.HttpErrorResponse({error:r.createErrorEvent(e,t)})},r.createErrorEvent=function(e,t){return new ErrorEvent(r.type,{error:new r(e,t)})},r}(w);E.type="JWT_CANNOT_REFRESH_ERROR";var R=function(e){function r(t,n){var o=e.call(this,t,n,r.type)||this;return o.originalRequest=t,o.originalError=n,o}return g(r,e),r.createErrorResponse=function(e,t){return new o.HttpErrorResponse({error:r.createErrorEvent(e,t)})},r.createErrorEvent=function(e,t){return new ErrorEvent(r.type,{error:new r(e,t)})},r}(w);R.type="JWT_COULDNT_REFRESH_ERROR";var j=function(e){return"string"==typeof e},m=function(e,r,t,n){if(j(e)){if(!t)throw new Error("JWT Refresh configuration error! `onFailure` is defined as a string, but the Router is not available! Is @angular/router installed and the RouterModule imported?");var o=n;"function"==typeof n&&(o=n(r)),t.navigate([e],{queryParams:o})}else e(r)},C=function(e){return null!=e},O=function(e,r,n,o){var i,a=null===(i=e.error)||void 0===i?void 0:i.error;return a instanceof E||a instanceof R?(n&&C(n.onFailure)&&m(n.onFailure,a,o,n.onFailureRedirectParameters),t.throwError(a)):a instanceof w?(C(r.onFailure)&&m(r.onFailure,a,o,r.onFailureRedirectParameters),t.throwError(a)):t.throwError(e)},k=function(e){return"function"==typeof e},b=function(e){return e&&"function"==typeof e.then&&"function"==typeof e.catch},A=function(e){return t.isObservable(e)?e:k(e)?t.of(null).pipe(n.switchMap((function(){var r=e();return t.isObservable(r)?r:b(r)?t.from(r):t.of(r)}))):b(e)?t.from(e):t.of(e)},I=function(e){return(r=Math.floor(1e3*e))-(new Date).getTime()<0?t.of(!0):t.merge(t.of(!1),t.timer(new Date(r)).pipe(n.mapTo(!0)));var r},_=function(e){return e.type===o.HttpEventType.Response},P=function(e,r,t,i,a){var s,u,c=new o.HttpRequest(null!==(s=t.method)&&void 0!==s?s:"POST",t.refreshUrl,r,(u=t.refreshRequestInitials,k(u)?u():u));return e.handle(c).pipe(n.filter(_),n.map((function(e){return t.transformRefreshResponse(e.body)})),n.tap((function(e){return t.setRefreshedTokens(e)})),n.mergeMap((function(e){return a(e)})),n.catchError(i))},H=function(e,r,o,i,a){var s,u,c,f,l,p,h,d;return"string"==typeof r||(u=r,p=function(e){return e===u.status},h=null===(f=null===(c=(s=o).errorCodeWhitelist)||void 0===c?void 0:c.some(p))||void 0===f||f,d=!(null===(l=s.errorCodeBlacklist)||void 0===l?void 0:l.some(p)),h&&d)?A(o.createRefreshRequestBody).pipe(n.take(1),n.switchMap((function(t){return t?P(e,t,o,i,a):i(r)}))):t.throwError(r)},S=function(e){try{return JSON.parse(a.Base64.decode(e))}catch(e){return console.error("Invalid Jsonlike Base64 string",e),null}},$=function(){function e(e,r,t){this.header=e,this.payload=r,this.signature=t}return e.from=function(r){var t=e.splitTokenString(r);if(!t)return null;var n=S(t[0]),o=S(t[1]),i=a.Base64.decode(t[2]);return n&&o&&i?new e(n,o,i):null},e.stripScheme=function(e,r){return e.substring((null!=r?r:"").length)},e.splitTokenString=function(r,t){void 0===t&&(t=e.JWT_TOKEN_SEPARATOR);var n=r.split(t);return 3!==n.length?null:n},e.prototype.isExpired=function(){return u(this.payload.exp)},e}();$.JWT_TOKEN_SEPARATOR=".";var D=new r.InjectionToken("AegisJwtConfiguration"),x=new r.InjectionToken("DefaultAegisJwtConfiguration"),N=new r.InjectionToken("AegisJwtRefreshConfiguration"),F=new r.InjectionToken("DefaultAegisJwtRefreshConfiguration"),J=function(){function e(e,r,o,i,a,s){var u;this.httpHandler=e,this.rawConfig=r,this.rawDefaultConfig=o,this.rawDefaultRefreshConfig=i,this.rawRefreshConfig=a,this.router=s,this.config=Object.assign(Object.assign({},this.rawDefaultConfig),this.rawConfig),this.refreshConfig=this.rawDefaultRefreshConfig&&this.rawRefreshConfig?Object.assign(Object.assign({},this.rawDefaultRefreshConfig),this.rawRefreshConfig):void 0,this.rawAccessToken$=A(this.config.getToken),this.rawRefreshToken$=(null===(u=this.refreshConfig)||void 0===u?void 0:u.getRefreshToken)?A(this.refreshConfig.getRefreshToken):t.of(null),this.accessToken$=this.rawAccessToken$.pipe(n.map((function(e){if(j(e)){var r=$.from(e);if(r)return r;throw new Error("Non-valid token observed")}return null}))),this.refreshToken$=this.rawRefreshToken$.pipe(n.map((function(e){if(j(e)){var r=$.from(e);if(r)return r;throw new Error("Non-valid token observed")}return null}))),this.accessTokenHeader$=this.accessToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.header)&&void 0!==r?r:null}))),this.accessTokenPayload$=this.accessToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.payload)&&void 0!==r?r:null}))),this.refreshTokenHeader$=this.refreshToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.header)&&void 0!==r?r:null}))),this.refreshTokenPayload$=this.refreshToken$.pipe(n.map((function(e){var r;return null!==(r=null==e?void 0:e.payload)&&void 0!==r?r:null}))),this.isAccessTokenExpired$=this.accessToken$.pipe(n.switchMap((function(e){return e?I(e.payload.exp):t.of(null)}))),this.isRefreshTokenExpired$=this.refreshToken$.pipe(n.switchMap((function(e){return e?I(e.payload.exp):t.of(null)}))),this.isAccessTokenValid$=this.isAccessTokenExpired$.pipe(n.map((function(e){return C(e)&&!e}))),this.isRefreshTokenValid$=this.isRefreshTokenExpired$.pipe(n.map((function(e){return C(e)&&!e})))}return e.prototype.manualRefresh=function(){var e=this;return this.refreshConfig?H(this.httpHandler,"Access token not valid on guard activation",this.refreshConfig,(function(r){return O(R.createErrorResponse(void 0,r),e.config,e.refreshConfig,e.router).pipe(n.catchError((function(){return t.of(!1)})))}),(function(){return t.of(!0)})):t.of(!1)},e}();J.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new J(r.ɵɵinject(o.HttpHandler),r.ɵɵinject(D),r.ɵɵinject(x),r.ɵɵinject(F,8),r.ɵɵinject(N,8),r.ɵɵinject(i.Router,8))},token:J,providedIn:"root"}),J.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],J.ctorParameters=function(){return[{type:o.HttpHandler},{type:void 0,decorators:[{type:r.Inject,args:[D]}]},{type:void 0,decorators:[{type:r.Inject,args:[x]}]},{type:void 0,decorators:[{type:r.Inject,args:[F]},{type:r.Optional}]},{type:void 0,decorators:[{type:r.Inject,args:[N]},{type:r.Optional}]},{type:i.Router,decorators:[{type:r.Optional}]}]};var M=function(){function e(e){this.jwtTokenService=e,this.isAccessTokenValidOnce$=this.jwtTokenService.isAccessTokenValid$.pipe(n.take(1))}return e.prototype.canActivate=function(e,r){var t=e.data;return this.isValid(null==t?void 0:t.isRefreshAllowed)},e.prototype.canActivateChild=function(e,r){var t=e.data;return this.isValid(null==t?void 0:t.isRefreshAllowed)},e.prototype.canLoad=function(e,r){var t=e.data;return this.isValid(null==t?void 0:t.isRefreshAllowed)},e.prototype.isValid=function(e){var r,o,i=this,a=null!==(o=null!=e?e:null===(r=this.jwtTokenService.refreshConfig)||void 0===r?void 0:r.isAutoRefreshAllowedInLoginGuardByDefault)&&void 0!==o?o:h;return this.isAccessTokenValidOnce$.pipe(n.switchMap((function(e){return!e&&a?i.jwtTokenService.manualRefresh():t.of(e)})))},e}();M.ɵprov=r.ɵɵdefineInjectable({factory:function(){return new M(r.ɵɵinject(J))},token:M,providedIn:"root"}),M.decorators=[{type:r.Injectable,args:[{providedIn:"root"}]}],M.ctorParameters=function(){return[{type:J}]};var W=function(){function e(e,r,t,n,o){this.router=o,this.jwtConfiguration=Object.assign(Object.assign({},r),e),this.jwtRefreshConfiguration=n&&t?Object.assign(Object.assign({},n),t):void 0}return e.prototype.intercept=function(e,r){var t=this;return r.handle(e).pipe(n.catchError((function(e){return O(e,t.jwtConfiguration,t.jwtRefreshConfiguration,t.router)})))},e}();W.decorators=[{type:r.Injectable}],W.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[D]}]},{type:void 0,decorators:[{type:r.Inject,args:[x]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[N]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[F]}]},{type:i.Router,decorators:[{type:r.Optional}]}]};var U=function(e,r){return j(e)?e===r:!!r&&e.test(r)},q=function(e,r){return void 0===r&&(r=!1),function(t){return r?!U(t,e):U(t,e)}},B=function(e,r){var t,n,o,i,a,s,u,c,f,l=r.domain,p=r.path,h=r.protocol,d=q(h),v=q(l),g=q(p),T=null===(n=null===(t=e.protocolWhitelist)||void 0===t?void 0:t.some(d))||void 0===n||n,y=!(null===(o=e.protocolBlacklist)||void 0===o?void 0:o.some(d)),w=null===(a=null===(i=e.domainWhitelist)||void 0===i?void 0:i.some(v))||void 0===a||a,E=!(null===(s=e.domainBlacklist)||void 0===s?void 0:s.some(v)),R=null===(c=null===(u=e.pathWhitelist)||void 0===u?void 0:u.some(g))||void 0===c||c,j=!(null===(f=e.pathBlacklist)||void 0===f?void 0:f.some(g));return T&&y&&w&&E&&R&&j},L=function(e){var r=null==e?void 0:e.match(/^((.*):\/\/)?([^/].*?)?(\/(.*))?$/);return{protocol:null==r?void 0:r[2],domain:null==r?void 0:r[3],path:null==r?void 0:r[5]}},G=function(){function e(e,r,t,n){this.jwtConfiguration=Object.assign(Object.assign({},r),e),this.jwtRefreshConfiguration=t&&n&&Object.assign(Object.assign({},n),t)}return e.prototype.intercept=function(e,r){var o=this,i=L(e.url);return A(this.jwtConfiguration.getToken).pipe(n.take(1),n.switchMap((function(n){if(B(o.jwtConfiguration,i)){var a=n&&$.from(n),s=!a||a.isExpired();if(!n||s&&!o.jwtRefreshConfiguration)return t.throwError(w.createErrorResponse(e,"Token is expired or invalid, and refresh is not configured."));var u=e.clone({headers:e.headers.set(o.jwtConfiguration.header,o.jwtConfiguration.scheme?o.jwtConfiguration.scheme+n:n)});return o.jwtConfiguration.handleWithCredentials&&(u=u.clone({withCredentials:!0})),r.handle(u)}return r.handle(e)})))},e}();G.decorators=[{type:r.Injectable}],G.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[D]}]},{type:void 0,decorators:[{type:r.Inject,args:[x]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[N]}]},{type:void 0,decorators:[{type:r.Optional},{type:r.Inject,args:[F]}]}]};var V=function(){function e(e,r,t,n){var o;this.jwtConfiguration=Object.assign(Object.assign({},r),e),this.jwtRefreshConfiguration=Object.assign(Object.assign({},n),t),this.rawRefreshToken$=A(null!==(o=this.jwtRefreshConfiguration.getRefreshToken)&&void 0!==o?o:function(){return null}),this.isRawRefreshTokenGetterAvailable=!!this.jwtRefreshConfiguration.getRefreshToken}return e.prototype.intercept=function(e,r){var o=this,i=L(e.url),a=e.headers.get(this.jwtConfiguration.header);return a&&!q(e.url)(this.jwtRefreshConfiguration.refreshUrl)&&B(this.jwtRefreshConfiguration,i)?this.rawRefreshToken$.pipe(n.take(1),n.switchMap((function(i){var s=$.stripScheme(a,o.jwtConfiguration.scheme),u=$.from(s),c=i?$.from(i):null,f=!u||u.isExpired(),l=!c||c.isExpired();return f&&o.isRawRefreshTokenGetterAvailable&&l?t.throwError(E.createErrorResponse(e,"Both access and refresh tokens are expired")):(f?t.throwError("Expired token, refresh first"):r.handle(e)).pipe(n.catchError((function(n){return H(r,n,o.jwtRefreshConfiguration,(function(r){return t.throwError(R.createErrorResponse(e,r))}),(function(t){var n=e.clone({headers:e.headers.set(o.jwtConfiguration.header,o.jwtConfiguration.scheme+t.accessToken)});return r.handle(n)}))})))}))):r.handle(e)},e}();V.decorators=[{type:r.Injectable}],V.ctorParameters=function(){return[{type:void 0,decorators:[{type:r.Inject,args:[D]}]},{type:void 0,decorators:[{type:r.Inject,args:[x]}]},{type:void 0,decorators:[{type:r.Inject,args:[N]}]},{type:void 0,decorators:[{type:r.Inject,args:[F]}]}]};var K,z=function(e){return Object.assign({provide:D,multi:!1},e)},Q=function(e){return Object.assign({provide:N,multi:!1},e)},X=function(){function e(){}return e.forRoot=function(r,t){return{ngModule:e,providers:y([{provide:o.HTTP_INTERCEPTORS,useClass:W,multi:!0},{provide:o.HTTP_INTERCEPTORS,useClass:G,multi:!0},{provide:x,useValue:p},z(r)],t?[{provide:o.HTTP_INTERCEPTORS,useClass:V,multi:!0},{provide:F,useValue:d},Q(t)]:[])}},e}();X.decorators=[{type:r.NgModule,args:[{imports:[s.CommonModule]}]}],(K=e.HttpMethod||(e.HttpMethod={})).GET="GET",K.HEAD="HEAD",K.POST="POST",K.PUT="PUT",K.DELETE="DELETE",K.CONNECT="CONNECT",K.OPTIONS="OPTIONS",K.TRACE="TRACE",K.PATCH="PATCH",e.DEFAULT_HEADER_CONFIG=c,e.DEFAULT_JWT_CONFIG=p,e.DEFAULT_JWT_HEADER=f,e.DEFAULT_JWT_REFRESH_CONFIG=d,e.DEFAULT_JWT_REFRESH_CONFIG_DEFAULT_AUTO_IN_GUARD=h,e.DEFAULT_JWT_SCHEME=l,e.JwtModule=X,e.JwtToken=$,e.JwtTokenService=J,e.LoginGuard=M,e.createJwtConfigurationProvider=z,e.createJwtRefreshConfigurationProvider=Q,e.isUnixTimestampExpired=u,e.ɵa=D,e.ɵb=x,e.ɵc=N,e.ɵd=F,e.ɵe=W,e.ɵf=G,e.ɵg=V,Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=aegis-auth-jwt.umd.min.js.map